<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <script src="javascripts/CanvasMatrix.js" type="text/javascript"></script>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>shinyRGL by trestletech</title>
  </head>

  <body onload="wClOVTFhoPWebGL.start()">
    <header>
      <div class="inner">
	<h1>WebGL in Shiny</h1>
	<h2>Shiny wrappers for RGL (WebGL) in R</h2>
        <a href="https://github.com/trestletech/shinyRGL" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a name="shiny-rgl" class="anchor" href="#shiny-rgl"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>ShinyRGL is a <a href="http://rstudio.com/shiny/">Shiny</a> wrapper for the <a href="https://r-forge.r-project.org/projects/rgl/">RGL package</a>. This package enables users to create Shiny apps that use
interactive 3D graphics in WebGL using the RGL package. The implementation can
be as simple as adding lines like the following:</p>

<p><span style="font-weight: bold;">ui.R</span></p>

<div class="highlight"><pre>...
  <span class="c"># Create an output element (works just like 'plotOutput()')</span>
  webGLOutput<span class="o">(</span><span class="s2">"myWebGL"</span><span class="o">)</span>
...
</pre></div>

<p><span style="font-weight: bold;">server.R</span></p>

<div class="highlight"><pre>...
  output<span class="nv">$myWebGL</span> &lt;- renderWebGL<span class="o">({</span>
    points3d<span class="o">(</span>1:10, 1:10, 1:10<span class="o">)</span>
    axes3d<span class="o">()</span>
  <span class="o">})</span>
...
</pre></div>

<p>Add this to your Shiny app, and you should see something like the following:</p>

  <canvas id="wClOVTFhoPtextureCanvas" style="display: none;" width="256" height="256">
        
  Your browser does not support the HTML5 canvas element.</canvas>

  <!-- ****** points object 12 ****** -->
  <script id="wClOVTFhoPvshader12" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  void main(void) {
    vPosition = mvMatrix * vec4(aPos, 1.);
    gl_Position = prMatrix * vPosition;
    gl_PointSize = 3.;
    vCol = aCol;
  }
  </script>

  <script id="wClOVTFhoPfshader12" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    gl_FragColor = lighteffect;
  }
  </script> 

  <!-- ****** lines object 14 ****** -->
  <script id="wClOVTFhoPvshader14" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  void main(void) {
    vPosition = mvMatrix * vec4(aPos, 1.);
    gl_Position = prMatrix * vPosition;
    vCol = aCol;
  }
  </script>

  <script id="wClOVTFhoPfshader14" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    gl_FragColor = lighteffect;
  }
  </script> 

  <!-- ****** text object 15 ****** -->
  <script id="wClOVTFhoPvshader15" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  attribute vec2 aTexcoord;
  varying vec2 vTexcoord;
  attribute vec2 aOfs;
  void main(void) {
    vCol = aCol;
    vTexcoord = aTexcoord;
    vec4 pos = prMatrix * mvMatrix * vec4(aPos, 1.);
    pos = pos/pos.w;
    gl_Position = pos + vec4(aOfs, 0.,0.);
  }
  </script>

  <script id="wClOVTFhoPfshader15" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  varying vec2 vTexcoord;
  uniform sampler2D uSampler;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    vec4 textureColor = lighteffect*texture2D(uSampler, vTexcoord);
    if (textureColor.a < 0.1)
      discard;
    else
      gl_FragColor = textureColor;
  }
  </script> 

  <!-- ****** lines object 16 ****** -->
  <script id="wClOVTFhoPvshader16" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  void main(void) {
    vPosition = mvMatrix * vec4(aPos, 1.);
    gl_Position = prMatrix * vPosition;
    vCol = aCol;
  }
  </script>

  <script id="wClOVTFhoPfshader16" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    gl_FragColor = lighteffect;
  }
  </script> 

  <!-- ****** text object 17 ****** -->
  <script id="wClOVTFhoPvshader17" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  attribute vec2 aTexcoord;
  varying vec2 vTexcoord;
  attribute vec2 aOfs;
  void main(void) {
    vCol = aCol;
    vTexcoord = aTexcoord;
    vec4 pos = prMatrix * mvMatrix * vec4(aPos, 1.);
    pos = pos/pos.w;
    gl_Position = pos + vec4(aOfs, 0.,0.);
  }
  </script>

  <script id="wClOVTFhoPfshader17" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  varying vec2 vTexcoord;
  uniform sampler2D uSampler;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    vec4 textureColor = lighteffect*texture2D(uSampler, vTexcoord);
    if (textureColor.a < 0.1)
      discard;
    else
      gl_FragColor = textureColor;
  }
  </script> 

  <!-- ****** lines object 18 ****** -->
  <script id="wClOVTFhoPvshader18" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  void main(void) {
    vPosition = mvMatrix * vec4(aPos, 1.);
    gl_Position = prMatrix * vPosition;
    vCol = aCol;
  }
  </script>

  <script id="wClOVTFhoPfshader18" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    gl_FragColor = lighteffect;
  }
  </script> 

  <!-- ****** text object 19 ****** -->
  <script id="wClOVTFhoPvshader19" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  attribute vec2 aTexcoord;
  varying vec2 vTexcoord;
  attribute vec2 aOfs;
  void main(void) {
    vCol = aCol;
    vTexcoord = aTexcoord;
    vec4 pos = prMatrix * mvMatrix * vec4(aPos, 1.);
    pos = pos/pos.w;
    gl_Position = pos + vec4(aOfs, 0.,0.);
  }
  </script>

  <script id="wClOVTFhoPfshader19" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  varying vec2 vTexcoord;
  uniform sampler2D uSampler;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    vec4 textureColor = lighteffect*texture2D(uSampler, vTexcoord);
    if (textureColor.a < 0.1)
      discard;
    else
      gl_FragColor = textureColor;
  }
  </script> 

  <!-- ****** lines object 20 ****** -->
  <script id="wClOVTFhoPvshader20" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec4 aCol;
  uniform mat4 mvMatrix;
  uniform mat4 prMatrix;
  varying vec4 vCol;
  varying vec4 vPosition;
  void main(void) {
    vPosition = mvMatrix * vec4(aPos, 1.);
    gl_Position = prMatrix * vPosition;
    vCol = aCol;
  }
  </script>

  <script id="wClOVTFhoPfshader20" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec4 vCol; // carries alpha
  varying vec4 vPosition;
  void main(void) {
      vec4 colDiff = vCol;
    vec4 lighteffect = colDiff;
    gl_FragColor = lighteffect;
  }
  </script> 


  <script type="text/javascript"> 

  var min = Math.min;
  var max = Math.max;
  var sqrt = Math.sqrt;
  var sin = Math.sin;
  var acos = Math.acos;
  var tan = Math.tan;
  var SQRT2 = Math.SQRT2;
  var PI = Math.PI;
  var log = Math.log;
  var exp = Math.exp;

  var wClOVTFhoPWebGLClass = function(){
    this.prefix="wClOVTFhoP";
    this.zoom = 1;
    this.userMatrix = null;
    this.panCallbacks = [];
    this.fovCallbacks = [];
    this.zoomCallbacks = [];
    this.fov = 1;
  };

  (function(){
    this.getShader = function( gl, id ){
     var shaderScript = document.getElementById ( id );
     var str = "";
     var k = shaderScript.firstChild;
     while ( k ){
       if ( k.nodeType == 3 ) str += k.textContent;
       k = k.nextSibling;
     }
     var shader;
     if ( shaderScript.type == "x-shader/x-fragment" )
             shader = gl.createShader ( gl.FRAGMENT_SHADER );
     else if ( shaderScript.type == "x-shader/x-vertex" )
             shader = gl.createShader(gl.VERTEX_SHADER);
     else return null;
     gl.shaderSource(shader, str);
     gl.compileShader(shader);
     if (gl.getShaderParameter(shader, gl.COMPILE_STATUS) == 0)
       alert(gl.getShaderInfoLog(shader));
     return shader;
    };

    this.start = function(){
     var debug = function(msg) {
       document.getElementById("wClOVTFhoPdebug").innerHTML = msg;
     }
     debug("");

     var canvas = document.getElementById("wClOVTFhoPcanvas");
     if (!window.WebGLRenderingContext){
       debug(" Your browser does not support WebGL. See <a href=\"http://get.webgl.org\">http://get.webgl.org</a>");
       return;
     }
     var gl;
     try {
       // Try to grab the standard context. If it fails, fallback to experimental.
       gl = canvas.getContext("webgl") 
         || canvas.getContext("experimental-webgl");
     }
     catch(e) {}
     if ( !gl ) {
       debug(" Your browser appears to support WebGL, but did not create a WebGL context.  See <a href=\"http://get.webgl.org\">http://get.webgl.org</a>");
       return;
     }
     var width = 688;  var height = 400;
     canvas.width = width;   canvas.height = height;
     gl.viewport(0, 0, width, height);
     var prMatrix = new CanvasMatrix4();
     var mvMatrix = new CanvasMatrix4();
     var normMatrix = new CanvasMatrix4();
     var saveMat = new CanvasMatrix4();
     saveMat.makeIdentity();
     var distance;
     var posLoc = 0;
     var colLoc = 1;

     this.setZoom(1);
     this.setFOV(30);
     this.userMatrix = new CanvasMatrix4();
     this.setUserMatrix([
      1, 0, 0, 0,
      0, 0.3420201, -0.9396926, 0,
      0, 0.9396926, 0.3420201, 0,
      0, 0, 0, 1
    ]);
     function getPowerOfTwo(value) {
       var pow = 1;
       while(pow<value) {
         pow *= 2;
       }
       return pow;
     }

     function handleLoadedTexture(texture, textureCanvas) {
       gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);

       gl.bindTexture(gl.TEXTURE_2D, texture);
       gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textureCanvas);
       gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
       gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
       gl.generateMipmap(gl.TEXTURE_2D);

       gl.bindTexture(gl.TEXTURE_2D, null);
     }
     
     function loadImageToTexture(filename, texture) {   
       var canvas = document.getElementById("wClOVTFhoPtextureCanvas");
       var ctx = canvas.getContext("2d");
       var image = new Image();
       
       image.onload = function() {
         var w = image.width;
         var h = image.height;
         var canvasX = getPowerOfTwo(w);
         var canvasY = getPowerOfTwo(h);
         canvas.width = canvasX;
         canvas.height = canvasY;
         ctx.imageSmoothingEnabled = true;
         ctx.drawImage(image, 0, 0, canvasX, canvasY);
         handleLoadedTexture(texture, canvas);
           drawScene.call(this);
       }
       image.src = filename;
     }       

     function drawTextToCanvas(text, cex) {
       var canvasX, canvasY;
       var textX, textY;

       var textHeight = 20 * cex;
       var textColour = "white";
       var fontFamily = "Arial";

       var backgroundColour = "rgba(0,0,0,0)";

       var canvas = document.getElementById("wClOVTFhoPtextureCanvas");
       var ctx = canvas.getContext("2d");

       ctx.font = textHeight+"px "+fontFamily;

             canvasX = 1;
             var widths = [];
       for (var i = 0; i < text.length; i++)  {
         widths[i] = ctx.measureText(text[i]).width;
         canvasX = (widths[i] > canvasX) ? widths[i] : canvasX;
       }    
       canvasX = getPowerOfTwo(canvasX);

       var offset = 2*textHeight; // offset to first baseline
       var skip = 2*textHeight;   // skip between baselines   
       canvasY = getPowerOfTwo(offset + text.length*skip);
       
       canvas.width = canvasX;
       canvas.height = canvasY;

       ctx.fillStyle = backgroundColour;
       ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

       ctx.fillStyle = textColour;
       ctx.textAlign = "left";

       ctx.textBaseline = "alphabetic";
       ctx.font = textHeight+"px "+fontFamily;

       for(var i = 0; i < text.length; i++) {
         textY = i*skip + offset;
         ctx.fillText(text[i], 0,  textY);
       }
       return {canvasX:canvasX, canvasY:canvasY,
               widths:widths, textHeight:textHeight,
               offset:offset, skip:skip};
     }


     // ****** points object 12 ******
     var prog12  = gl.createProgram();
     gl.attachShader(prog12, this.getShader( gl, "wClOVTFhoPvshader12" ));
     gl.attachShader(prog12, this.getShader( gl, "wClOVTFhoPfshader12" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog12, 0, "aPos");
     gl.bindAttribLocation(prog12, 1, "aCol");
     gl.linkProgram(prog12);
     var v=new Float32Array([
      1, 1, 1,
      2, 2, 2,
      3, 3, 3,
      4, 4, 4,
      5, 5, 5,
      6, 6, 6,
      7, 7, 7,
      8, 8, 8,
      9, 9, 9,
      10, 10, 10
     ]);
     var buf12 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf12);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var mvMatLoc12 = gl.getUniformLocation(prog12,"mvMatrix");
     var prMatLoc12 = gl.getUniformLocation(prog12,"prMatrix");


     // ****** lines object 14 ******
     var prog14  = gl.createProgram();
     gl.attachShader(prog14, this.getShader( gl, "wClOVTFhoPvshader14" ));
     gl.attachShader(prog14, this.getShader( gl, "wClOVTFhoPfshader14" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog14, 0, "aPos");
     gl.bindAttribLocation(prog14, 1, "aCol");
     gl.linkProgram(prog14);
     var v=new Float32Array([
      2, 0.865, 0.865,
      10, 0.865, 0.865,
      2, 0.865, 0.865,
      2, 0.63325, 0.63325,
      4, 0.865, 0.865,
      4, 0.63325, 0.63325,
      6, 0.865, 0.865,
      6, 0.63325, 0.63325,
      8, 0.865, 0.865,
      8, 0.63325, 0.63325,
      10, 0.865, 0.865,
      10, 0.63325, 0.63325
     ]);
     var buf14 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf14);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var mvMatLoc14 = gl.getUniformLocation(prog14,"mvMatrix");
     var prMatLoc14 = gl.getUniformLocation(prog14,"prMatrix");


     // ****** text object 15 ******
     var prog15  = gl.createProgram();
     gl.attachShader(prog15, this.getShader( gl, "wClOVTFhoPvshader15" ));
     gl.attachShader(prog15, this.getShader( gl, "wClOVTFhoPfshader15" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog15, 0, "aPos");
     gl.bindAttribLocation(prog15, 1, "aCol");
     gl.linkProgram(prog15);
     var texts = [
      "2",
      "4",
      "6",
      "8",
      "10"
     ];
     var texinfo = drawTextToCanvas(texts, 1);   
     var canvasX15 = texinfo.canvasX;
     var canvasY15 = texinfo.canvasY;
     var ofsLoc15 = gl.getAttribLocation(prog15, "aOfs");
     var texture15 = gl.createTexture();
     var texLoc15 = gl.getAttribLocation(prog15, "aTexcoord");
     var sampler15 = gl.getUniformLocation(prog15,"uSampler");
         handleLoadedTexture(texture15, document.getElementById("wClOVTFhoPtextureCanvas"));
     var v=new Float32Array([
      2, 0.16975, 0.16975, 0, -0.5, 0.5, 0.5,
      2, 0.16975, 0.16975, 1, -0.5, 0.5, 0.5,
      2, 0.16975, 0.16975, 1, 1.5, 0.5, 0.5,
      2, 0.16975, 0.16975, 0, 1.5, 0.5, 0.5,
      4, 0.16975, 0.16975, 0, -0.5, 0.5, 0.5,
      4, 0.16975, 0.16975, 1, -0.5, 0.5, 0.5,
      4, 0.16975, 0.16975, 1, 1.5, 0.5, 0.5,
      4, 0.16975, 0.16975, 0, 1.5, 0.5, 0.5,
      6, 0.16975, 0.16975, 0, -0.5, 0.5, 0.5,
      6, 0.16975, 0.16975, 1, -0.5, 0.5, 0.5,
      6, 0.16975, 0.16975, 1, 1.5, 0.5, 0.5,
      6, 0.16975, 0.16975, 0, 1.5, 0.5, 0.5,
      8, 0.16975, 0.16975, 0, -0.5, 0.5, 0.5,
      8, 0.16975, 0.16975, 1, -0.5, 0.5, 0.5,
      8, 0.16975, 0.16975, 1, 1.5, 0.5, 0.5,
      8, 0.16975, 0.16975, 0, 1.5, 0.5, 0.5,
      10, 0.16975, 0.16975, 0, -0.5, 0.5, 0.5,
      10, 0.16975, 0.16975, 1, -0.5, 0.5, 0.5,
      10, 0.16975, 0.16975, 1, 1.5, 0.5, 0.5,
      10, 0.16975, 0.16975, 0, 1.5, 0.5, 0.5
     ]);
     for (var i=0; i<5; i++) 
       for (var j=0; j<4; j++) {
           ind = 7*(4*i + j) + 3;
           v[ind+2] = 2*(v[ind]-v[ind+2])*texinfo.widths[i]/width;
           v[ind+3] = 2*(v[ind+1]-v[ind+3])*texinfo.textHeight/height;
           v[ind] *= texinfo.widths[i]/texinfo.canvasX;
           v[ind+1] = 1.0-(texinfo.offset + i*texinfo.skip 
             - v[ind+1]*texinfo.textHeight)/texinfo.canvasY;
       }
     var f=new Uint16Array([
      0, 1, 2, 0, 2, 3,
      4, 5, 6, 4, 6, 7,
      8, 9, 10, 8, 10, 11,
      12, 13, 14, 12, 14, 15,
      16, 17, 18, 16, 18, 19
     ]);
     var buf15 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf15);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var ibuf15 = gl.createBuffer();
     gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf15);
     gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, f, gl.STATIC_DRAW);
     var mvMatLoc15 = gl.getUniformLocation(prog15,"mvMatrix");
     var prMatLoc15 = gl.getUniformLocation(prog15,"prMatrix");


     // ****** lines object 16 ******
     var prog16  = gl.createProgram();
     gl.attachShader(prog16, this.getShader( gl, "wClOVTFhoPvshader16" ));
     gl.attachShader(prog16, this.getShader( gl, "wClOVTFhoPfshader16" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog16, 0, "aPos");
     gl.bindAttribLocation(prog16, 1, "aCol");
     gl.linkProgram(prog16);
     var v=new Float32Array([
      0.865, 2, 0.865,
      0.865, 10, 0.865,
      0.865, 2, 0.865,
      0.63325, 2, 0.63325,
      0.865, 4, 0.865,
      0.63325, 4, 0.63325,
      0.865, 6, 0.865,
      0.63325, 6, 0.63325,
      0.865, 8, 0.865,
      0.63325, 8, 0.63325,
      0.865, 10, 0.865,
      0.63325, 10, 0.63325
     ]);
     var buf16 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf16);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var mvMatLoc16 = gl.getUniformLocation(prog16,"mvMatrix");
     var prMatLoc16 = gl.getUniformLocation(prog16,"prMatrix");


     // ****** text object 17 ******
     var prog17  = gl.createProgram();
     gl.attachShader(prog17, this.getShader( gl, "wClOVTFhoPvshader17" ));
     gl.attachShader(prog17, this.getShader( gl, "wClOVTFhoPfshader17" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog17, 0, "aPos");
     gl.bindAttribLocation(prog17, 1, "aCol");
     gl.linkProgram(prog17);
     var texts = [
      "2",
      "4",
      "6",
      "8",
      "10"
     ];
     var texinfo = drawTextToCanvas(texts, 1);   
     var canvasX17 = texinfo.canvasX;
     var canvasY17 = texinfo.canvasY;
     var ofsLoc17 = gl.getAttribLocation(prog17, "aOfs");
     var texture17 = gl.createTexture();
     var texLoc17 = gl.getAttribLocation(prog17, "aTexcoord");
     var sampler17 = gl.getUniformLocation(prog17,"uSampler");
         handleLoadedTexture(texture17, document.getElementById("wClOVTFhoPtextureCanvas"));
     var v=new Float32Array([
      0.16975, 2, 0.16975, 0, -0.5, 0.5, 0.5,
      0.16975, 2, 0.16975, 1, -0.5, 0.5, 0.5,
      0.16975, 2, 0.16975, 1, 1.5, 0.5, 0.5,
      0.16975, 2, 0.16975, 0, 1.5, 0.5, 0.5,
      0.16975, 4, 0.16975, 0, -0.5, 0.5, 0.5,
      0.16975, 4, 0.16975, 1, -0.5, 0.5, 0.5,
      0.16975, 4, 0.16975, 1, 1.5, 0.5, 0.5,
      0.16975, 4, 0.16975, 0, 1.5, 0.5, 0.5,
      0.16975, 6, 0.16975, 0, -0.5, 0.5, 0.5,
      0.16975, 6, 0.16975, 1, -0.5, 0.5, 0.5,
      0.16975, 6, 0.16975, 1, 1.5, 0.5, 0.5,
      0.16975, 6, 0.16975, 0, 1.5, 0.5, 0.5,
      0.16975, 8, 0.16975, 0, -0.5, 0.5, 0.5,
      0.16975, 8, 0.16975, 1, -0.5, 0.5, 0.5,
      0.16975, 8, 0.16975, 1, 1.5, 0.5, 0.5,
      0.16975, 8, 0.16975, 0, 1.5, 0.5, 0.5,
      0.16975, 10, 0.16975, 0, -0.5, 0.5, 0.5,
      0.16975, 10, 0.16975, 1, -0.5, 0.5, 0.5,
      0.16975, 10, 0.16975, 1, 1.5, 0.5, 0.5,
      0.16975, 10, 0.16975, 0, 1.5, 0.5, 0.5
     ]);
     for (var i=0; i<5; i++) 
       for (var j=0; j<4; j++) {
           ind = 7*(4*i + j) + 3;
           v[ind+2] = 2*(v[ind]-v[ind+2])*texinfo.widths[i]/width;
           v[ind+3] = 2*(v[ind+1]-v[ind+3])*texinfo.textHeight/height;
           v[ind] *= texinfo.widths[i]/texinfo.canvasX;
           v[ind+1] = 1.0-(texinfo.offset + i*texinfo.skip 
             - v[ind+1]*texinfo.textHeight)/texinfo.canvasY;
       }
     var f=new Uint16Array([
      0, 1, 2, 0, 2, 3,
      4, 5, 6, 4, 6, 7,
      8, 9, 10, 8, 10, 11,
      12, 13, 14, 12, 14, 15,
      16, 17, 18, 16, 18, 19
     ]);
     var buf17 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf17);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var ibuf17 = gl.createBuffer();
     gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf17);
     gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, f, gl.STATIC_DRAW);
     var mvMatLoc17 = gl.getUniformLocation(prog17,"mvMatrix");
     var prMatLoc17 = gl.getUniformLocation(prog17,"prMatrix");


     // ****** lines object 18 ******
     var prog18  = gl.createProgram();
     gl.attachShader(prog18, this.getShader( gl, "wClOVTFhoPvshader18" ));
     gl.attachShader(prog18, this.getShader( gl, "wClOVTFhoPfshader18" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog18, 0, "aPos");
     gl.bindAttribLocation(prog18, 1, "aCol");
     gl.linkProgram(prog18);
     var v=new Float32Array([
      0.865, 0.865, 2,
      0.865, 0.865, 10,
      0.865, 0.865, 2,
      0.63325, 0.63325, 2,
      0.865, 0.865, 4,
      0.63325, 0.63325, 4,
      0.865, 0.865, 6,
      0.63325, 0.63325, 6,
      0.865, 0.865, 8,
      0.63325, 0.63325, 8,
      0.865, 0.865, 10,
      0.63325, 0.63325, 10
     ]);
     var buf18 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf18);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var mvMatLoc18 = gl.getUniformLocation(prog18,"mvMatrix");
     var prMatLoc18 = gl.getUniformLocation(prog18,"prMatrix");


     // ****** text object 19 ******
     var prog19  = gl.createProgram();
     gl.attachShader(prog19, this.getShader( gl, "wClOVTFhoPvshader19" ));
     gl.attachShader(prog19, this.getShader( gl, "wClOVTFhoPfshader19" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog19, 0, "aPos");
     gl.bindAttribLocation(prog19, 1, "aCol");
     gl.linkProgram(prog19);
     var texts = [
      "2",
      "4",
      "6",
      "8",
      "10"
     ];
     var texinfo = drawTextToCanvas(texts, 1);   
     var canvasX19 = texinfo.canvasX;
     var canvasY19 = texinfo.canvasY;
     var ofsLoc19 = gl.getAttribLocation(prog19, "aOfs");
     var texture19 = gl.createTexture();
     var texLoc19 = gl.getAttribLocation(prog19, "aTexcoord");
     var sampler19 = gl.getUniformLocation(prog19,"uSampler");
         handleLoadedTexture(texture19, document.getElementById("wClOVTFhoPtextureCanvas"));
     var v=new Float32Array([
      0.16975, 0.16975, 2, 0, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 2, 1, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 2, 1, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 2, 0, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 4, 0, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 4, 1, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 4, 1, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 4, 0, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 6, 0, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 6, 1, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 6, 1, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 6, 0, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 8, 0, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 8, 1, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 8, 1, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 8, 0, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 10, 0, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 10, 1, -0.5, 0.5, 0.5,
      0.16975, 0.16975, 10, 1, 1.5, 0.5, 0.5,
      0.16975, 0.16975, 10, 0, 1.5, 0.5, 0.5
     ]);
     for (var i=0; i<5; i++) 
       for (var j=0; j<4; j++) {
           ind = 7*(4*i + j) + 3;
           v[ind+2] = 2*(v[ind]-v[ind+2])*texinfo.widths[i]/width;
           v[ind+3] = 2*(v[ind+1]-v[ind+3])*texinfo.textHeight/height;
           v[ind] *= texinfo.widths[i]/texinfo.canvasX;
           v[ind+1] = 1.0-(texinfo.offset + i*texinfo.skip 
             - v[ind+1]*texinfo.textHeight)/texinfo.canvasY;
       }
     var f=new Uint16Array([
      0, 1, 2, 0, 2, 3,
      4, 5, 6, 4, 6, 7,
      8, 9, 10, 8, 10, 11,
      12, 13, 14, 12, 14, 15,
      16, 17, 18, 16, 18, 19
     ]);
     var buf19 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf19);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var ibuf19 = gl.createBuffer();
     gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf19);
     gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, f, gl.STATIC_DRAW);
     var mvMatLoc19 = gl.getUniformLocation(prog19,"mvMatrix");
     var prMatLoc19 = gl.getUniformLocation(prog19,"prMatrix");


     // ****** lines object 20 ******
     var prog20  = gl.createProgram();
     gl.attachShader(prog20, this.getShader( gl, "wClOVTFhoPvshader20" ));
     gl.attachShader(prog20, this.getShader( gl, "wClOVTFhoPfshader20" ));
     //  Force aPos to location 0, aCol to location 1 
     gl.bindAttribLocation(prog20, 0, "aPos");
     gl.bindAttribLocation(prog20, 1, "aCol");
     gl.linkProgram(prog20);
     var v=new Float32Array([
      0.865, 0.865, 0.865,
      0.865, 10.135, 0.865,
      0.865, 0.865, 10.135,
      0.865, 10.135, 10.135,
      0.865, 0.865, 0.865,
      0.865, 0.865, 10.135,
      0.865, 10.135, 0.865,
      0.865, 10.135, 10.135,
      0.865, 0.865, 0.865,
      10.135, 0.865, 0.865,
      0.865, 0.865, 10.135,
      10.135, 0.865, 10.135,
      0.865, 10.135, 0.865,
      10.135, 10.135, 0.865,
      0.865, 10.135, 10.135,
      10.135, 10.135, 10.135,
      10.135, 0.865, 0.865,
      10.135, 10.135, 0.865,
      10.135, 0.865, 10.135,
      10.135, 10.135, 10.135,
      10.135, 0.865, 0.865,
      10.135, 0.865, 10.135,
      10.135, 10.135, 0.865,
      10.135, 10.135, 10.135
     ]);
     var buf20 = gl.createBuffer();
     gl.bindBuffer(gl.ARRAY_BUFFER, buf20);
     gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
     var mvMatLoc20 = gl.getUniformLocation(prog20,"mvMatrix");
     var prMatLoc20 = gl.getUniformLocation(prog20,"prMatrix");

     gl.enable(gl.DEPTH_TEST);
     gl.depthFunc(gl.LEQUAL);
     gl.clearDepth(1.0);
     gl.clearColor(1, 1, 1, 1);
     var xOffs = yOffs = 0,  drag  = 0;
     drawScene.call(this);

  
     function drawScene(){
       gl.depthMask(true);
       gl.disable(gl.BLEND);
       var radius = 8.573651;
       var s = sin(this.fov*PI/360);
       var t = tan(this.fov*PI/360);
       var distance = radius/s;
       var near = distance - radius;
       var far = distance + radius;
       var hlen = t*near;
       var aspect = width/height;
       prMatrix.makeIdentity();
       if (aspect > 1)
         prMatrix.frustum(-hlen*aspect*this.zoom, hlen*aspect*this.zoom, 
                          -hlen*this.zoom, hlen*this.zoom, near, far);
       else  
         prMatrix.frustum(-hlen*this.zoom, hlen*this.zoom, 
                          -hlen*this.zoom/aspect, hlen*this.zoom/aspect, 
                          near, far);
       mvMatrix.makeIdentity();
       mvMatrix.translate( -5.5, -5.5, -5.5 );
       mvMatrix.scale( 1, 1, 1 );   
       mvMatrix.multRight( this.userMatrix );  
       mvMatrix.translate(0, 0, -distance);
       gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);


       // ****** points object 12 *******
       gl.useProgram(prog12);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf12);
       gl.uniformMatrix4fv( prMatLoc12, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc12, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 12,  0);
       gl.drawArrays(gl.POINTS, 0, 10);

       // ****** lines object 14 *******
       gl.useProgram(prog14);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf14);
       gl.uniformMatrix4fv( prMatLoc14, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc14, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.lineWidth( 1 );
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 12,  0);
       gl.drawArrays(gl.LINES, 0, 12);

       // ****** text object 15 *******
       gl.useProgram(prog15);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf15);
       gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf15);
       gl.uniformMatrix4fv( prMatLoc15, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc15, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.enableVertexAttribArray( texLoc15 );
       gl.vertexAttribPointer(texLoc15, 2, gl.FLOAT, false, 28, 12);
       gl.activeTexture(gl.TEXTURE0);
       gl.bindTexture(gl.TEXTURE_2D, texture15);
       gl.uniform1i( sampler15, 0);
       gl.enableVertexAttribArray( ofsLoc15 );
       gl.vertexAttribPointer(ofsLoc15, 2, gl.FLOAT, false, 28, 20);
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 28,  0);
       gl.drawElements(gl.TRIANGLES, 30, gl.UNSIGNED_SHORT, 0);

       // ****** lines object 16 *******
       gl.useProgram(prog16);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf16);
       gl.uniformMatrix4fv( prMatLoc16, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc16, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.lineWidth( 1 );
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 12,  0);
       gl.drawArrays(gl.LINES, 0, 12);

       // ****** text object 17 *******
       gl.useProgram(prog17);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf17);
       gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf17);
       gl.uniformMatrix4fv( prMatLoc17, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc17, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.enableVertexAttribArray( texLoc17 );
       gl.vertexAttribPointer(texLoc17, 2, gl.FLOAT, false, 28, 12);
       gl.activeTexture(gl.TEXTURE0);
       gl.bindTexture(gl.TEXTURE_2D, texture17);
       gl.uniform1i( sampler17, 0);
       gl.enableVertexAttribArray( ofsLoc17 );
       gl.vertexAttribPointer(ofsLoc17, 2, gl.FLOAT, false, 28, 20);
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 28,  0);
       gl.drawElements(gl.TRIANGLES, 30, gl.UNSIGNED_SHORT, 0);

       // ****** lines object 18 *******
       gl.useProgram(prog18);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf18);
       gl.uniformMatrix4fv( prMatLoc18, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc18, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.lineWidth( 1 );
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 12,  0);
       gl.drawArrays(gl.LINES, 0, 12);

       // ****** text object 19 *******
       gl.useProgram(prog19);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf19);
       gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf19);
       gl.uniformMatrix4fv( prMatLoc19, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc19, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.enableVertexAttribArray( texLoc19 );
       gl.vertexAttribPointer(texLoc19, 2, gl.FLOAT, false, 28, 12);
       gl.activeTexture(gl.TEXTURE0);
       gl.bindTexture(gl.TEXTURE_2D, texture19);
       gl.uniform1i( sampler19, 0);
       gl.enableVertexAttribArray( ofsLoc19 );
       gl.vertexAttribPointer(ofsLoc19, 2, gl.FLOAT, false, 28, 20);
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 28,  0);
       gl.drawElements(gl.TRIANGLES, 30, gl.UNSIGNED_SHORT, 0);

       // ****** lines object 20 *******
       gl.useProgram(prog20);
       gl.bindBuffer(gl.ARRAY_BUFFER, buf20);
       gl.uniformMatrix4fv( prMatLoc20, false, new Float32Array(prMatrix.getAsArray()) );
       gl.uniformMatrix4fv( mvMatLoc20, false, new Float32Array(mvMatrix.getAsArray()) );
       gl.enableVertexAttribArray( posLoc );
       gl.disableVertexAttribArray( colLoc );
       gl.vertexAttrib4f( colLoc, 0, 0, 0, 1 );
       gl.lineWidth( 1 );
       gl.vertexAttribPointer(posLoc,  3, gl.FLOAT, false, 12,  0);
       gl.drawArrays(gl.LINES, 0, 24);

       gl.flush ();
     }

     var vlen = function(v) {
       return sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2])
     }
     
     var xprod = function(a, b) {
       return [a[1]*b[2] - a[2]*b[1],
               a[2]*b[0] - a[0]*b[2],
               a[0]*b[1] - a[1]*b[0]];
     }

     var screenToVector = function(x, y) {
       var radius = max(width, height)/2.0;
       var cx = width/2.0;
       var cy = height/2.0;
       var px = (x-cx)/radius;
       var py = (y-cy)/radius;
       var plen = sqrt(px*px+py*py);
       if (plen > 1.e-6) { 
         px = px/plen;
         py = py/plen;
       }

       var angle = (SQRT2 - plen)/SQRT2*PI/2;
       var z = sin(angle);
       var zlen = sqrt(1.0 - z*z);
       px = px * zlen;
       py = py * zlen;
       return [px, py, z];
     }

     var rotBase;
     var self = this;

     var trackballdown = function(x,y) {
       rotBase = screenToVector(x, y);
       saveMat.load(self.userMatrix);
     }
     
     var trackballmove = function(x,y) {
       var rotCurrent = screenToVector(x,y);
       var dot = rotBase[0]*rotCurrent[0] + 
             rotBase[1]*rotCurrent[1] + 
             rotBase[2]*rotCurrent[2];
       var angle = acos( dot/vlen(rotBase)/vlen(rotCurrent) )*180./PI;
       var axis = xprod(rotBase, rotCurrent);
       saveMat.rotate(angle, axis[0], axis[1], axis[2]);
       self.setUserMatrix(saveMat);      
       drawScene.call(self);
       rotBase = screenToVector(x, y);
     }

     var y0zoom = 0;
     var zoom0 = 1;
     var zoomdown = function(x, y) {
       y0zoom = y;
       zoom0 = log(self.zoom);
     }

     var zoommove = function(x, y) {
       self.setZoom(exp(zoom0 + (y-y0zoom)/height));
       drawScene.call(self);
     }

     var y0fov = 0;
     var fov0 = 1;
     var fovdown = function(x, y) {
       y0fov = y;
       fov0 = self.fov;
     }

     var fovmove = function(x, y) {
       self.setFOV(max(1, min(179, fov0 + 180*(y-y0fov)/height)));
       drawScene.call(self);
     }

     var mousedown = [trackballdown, zoomdown, fovdown];
     var mousemove = [trackballmove, zoommove, fovmove];

     function relMouseCoords(event){
       var totalOffsetX = 0;
       var totalOffsetY = 0;
       var currentElement = canvas;
     
       do{
         totalOffsetX += currentElement.offsetLeft;
         totalOffsetY += currentElement.offsetTop;
       }
       while(currentElement = currentElement.offsetParent)
     
       var canvasX = event.pageX - totalOffsetX;
       var canvasY = event.pageY - totalOffsetY;
     
       return {x:canvasX, y:canvasY}
     }

     canvas.onmousedown = function ( ev ){
       if (!ev.which) // Use w3c defns in preference to MS
         switch (ev.button) {
         case 0: ev.which = 1; break;
         case 1: 
         case 4: ev.which = 2; break;
         case 2: ev.which = 3;
       }
       drag = ev.which;
       var f = mousedown[drag-1];
       if (f) {
         var coords = relMouseCoords(ev);
         f(coords.x, height-coords.y); 
         ev.preventDefault();
       }
     }    

     canvas.onmouseup = function ( ev ){  
       drag = 0;
     }
     
     canvas.onmouseout = canvas.onmouseup;

     canvas.onmousemove = function ( ev ){
       if ( drag == 0 ) return;
       var f = mousemove[drag-1];
       if (f) {
         var coords = relMouseCoords(ev);
         f(coords.x, height-coords.y);
       }
     }

     var wheelHandler = function(ev) {
       var del = 1.1;
       if (ev.shiftKey) del = 1.01;
       var ds = ((ev.detail || ev.wheelDelta) > 0) ? del : (1 / del);
       self.setZoom(self.zoom * ds);
       drawScene.call(self);
       ev.preventDefault();
     };
     canvas.addEventListener("DOMMouseScroll", wheelHandler, false);
     canvas.addEventListener("mousewheel", wheelHandler, false);

    };
  
    this.setZoom = function(zoom){
      this.zoom = zoom;
      for (var i = 0; i < this.zoomCallbacks.length; i++){
        this.zoomCallbacks[i](zoom);
      }
    };

    this.setUserMatrix = function(mat){
      this.userMatrix.load(mat);
      for (var i = 0; i < this.panCallbacks.length; i++){
        this.panCallbacks[i](this.userMatrix);
      }
    };

    this.setFOV = function(fov){
      this.fov = fov;
      for (var i = 0; i < this.fovCallbacks.length; i++){
        this.fovCallbacks[i](this.fov);
      }
    }

    this.getZoom = function(){
      return this.zoom;
    };

    this.getFOV = function(){
      return this.fov;
    }

    this.getUserMatrix = function(){
      return this.userMatrix;
    };

    this.onPan = function(callback){
      this.panCallbacks.push(callback);
    };

    this.onZoom = function(callback){
      this.zoomCallbacks.push(callback);
    };

    this.onFOV = function(callback){
      this.fovCallbacks.push(callback);
    }

  }).call(wClOVTFhoPWebGLClass.prototype);

  wClOVTFhoPWebGL = new wClOVTFhoPWebGLClass();

  </script>

  <canvas id="wClOVTFhoPcanvas" width="1" height="1"></canvas> 
        <p id="wClOVTFhoPdebug">
  
  You must enable Javascript to view this page properly.</p>


<h1>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>You can install the latest version of the code using the <code>devtools</code> R package.</p>

<pre><code># Install devtools, if you haven't already.
install.packages("devtools")

library(devtools)
install_github("shinyRGL", "trestletech")
</code></pre>

<h1>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h1>

<p>The development of this project was generously sponsored by the <a href="http://www.irsn.fr/EN/Pages/home.aspx">Institut de 
Radioprotection et de Sûreté Nucléaire</a> 
and performed by <a href="http://trestletech.com">Jeff Allen</a>. The code is
licensed under The MIT License (MIT).</p>

<p>Copyright (c) 2013 Institut de Radioprotection et de Sûreté Nucléaire</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/trestletech/shinyRGL/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/trestletech/shinyRGL/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/trestletech/shinyRGL"></a> is maintained by <a href="https://github.com/trestletech">trestletech</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-43159940-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
